import requests
import json
import pandas as pd
import streamlit as st

def retrieve_data(ticker):
    url = f'https://www.asx.com.au/asx/1/company/{ticker}/announcements?count=20&market_sensitive=false'
    headers = {
        'User-Agent':'Chrome/127.0.0.1 Safari/537.36',
        'Cookie':'JSESSIONID=4ZJKK-odV_4dAfqR_Yx5UUIycrYBnUhY0Gy3Epu7.node204; TS01a6083b=01856a822a79516cb7aff46aa01ccb9a8b86fbf252ebf9b299ac23df55651dbaabb0ef3a9bccd0e9b889ddceeda21b83178696b750; visid_incap_2835827=QlqLfN5iRVSEalIINR8LYQv0vWYAAAAAQUIPAAAAAAAy9FMXvMMID9B94r7UNqXT; affinity="c948963760209d11"; JSESSIONID=.node204; nlbi_2835827_2708396=x+qSQxdQa0aN9OH/2S5TNgAAAABgQaR6oE6TibmoYojbpuls; _gcl_au=1.1.435574352.1723725040; _ga=GA1.1.420937008.1723725040; OptanonAlertBoxClosed=2024-08-15T12:30:47.587Z; _hjSessionUser_3043058=eyJpZCI6Ijg1ZTNlYmU4LTBkOTYtNTdkOC05NGRkLTdmNTExMWVkZmRjMyIsImNyZWF0ZWQiOjE3MjM3MjUwNDgzMDcsImV4aXN0aW5nIjp0cnVlfQ==; __utma=51794233.420937008.1723725040.1723725063.1723725063.1; __utmc=51794233; __utmz=51794233.1723725063.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none); AMCVS_FD20401053DA8A4F0A490D4C%40AdobeOrg=1; AMCV_FD20401053DA8A4F0A490D4C%40AdobeOrg=-1758798782%7CMCIDTS%7C19951%7CMCMID%7C60847442457161467392706589270230964248%7CMCAAMLH-1724329862%7C7%7CMCAAMB-1724329863%7CRKhpRz8krg2tLO6pguXWp5olkAcUniQYPHaMWWgdJ3xzPWQmdj0y%7CMCOPTOUT-1723732263s%7CNONE%7CMCAID%7C3323B8D0A3ADF485-60001E3BE5A813FE; _fbp=fb.2.1723725063364.997626631219154117; s_nr=1723725063439-New; s_cc=true; s_fid=7A5A8B36C867174B-3BDF8BFF5D1347CE; s_cmpid=%7E%7E%7E%7E; s_cpc=1; __gads=ID=97dbb63869120d6a:T=1723725063:RT=1723725063:S=ALNI_MameuldnfrTw5DR2ipPVoZVeI_FgQ; __gpi=UID=00000ecb329f5c36:T=1723725063:RT=1723725063:S=ALNI_MZFOlvcgehJWPjOm8pQ1sftqye-EA; __eoi=ID=163c24e138428b02:T=1723725063:RT=1723725063:S=AA-AfjbTCGl8g5BxDYX6-AH9AEsI; OptanonConsent=isIABGlobal=false&datestamp=Thu+Aug+15+2024+08%3A35%3A59+GMT-0400+(Eastern+Daylight+Time)&version=6.13.0&hosts=&consentId=64e041ba-5d4d-4289-b493-ff112d0b04b0&interactionCount=2&landingPath=NotLandingPage&groups=C0001%3A1%2CC0002%3A1%2CC0003%3A1%2CC0004%3A1&AwaitingReconsent=false&geolocation=CA%3BON; nlbi_2835827=a670bgsGH13D82Zl2S5TNgAAAAB0tIrB1b+9lTJnOzGbHtsd; _ga_J1L799T374=GS1.1.1723725042.1.1.1723725383.49.0.0; _ga_PMPRR01441=GS1.1.1723725039.1.1.1723725383.0.0.0; incap_ses_1293_2835827=Z3+SUTCDIAzSfNSJxKjxEVb7vWYAAAAA0ALoG5+HHV3oGf6FBkVpPQ==; TS019c39fc=01856a822a786353337bd3164b1e7818f1c1acc56a076e613ff05d2b1b8a8eaae082b11ab7812e1269fbdc7f4418d8c6e14ae5cac7',
        'Accept':'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7'
    }

    response = requests.get(url,headers=None)

    if response.status_code == 200:
        st.write(response.text)
        # print("--------------------------------------------\n"+response.text)
        # data = response.json()['data']
        # extra line
        # data1 = json.dumps(response)
        data = {"data":[{"id":"02839968","document_release_date":"2024-08-15T14:53:40+1000","document_date":"2024-08-15T14:52:28+1000","url":"https://announcements.asx.com.au/asxpdf/20240815/pdf/066nj3f5lb1dpm.pdf","relative_url":"/asxpdf/20240815/pdf/066nj3f5lb1dpm.pdf","header":"Notification regarding unquoted securities - AEE","market_sensitive":false,"number_of_pages":7,"size":"21.5KB","legacy_announcement":false,"issuer_code":"AEE","issuer_short_name":"AURA EN","issuer_full_name":"AURA ENERGY LIMITED"},{"id":"02839899","document_release_date":"2024-08-15T11:11:09+1000","document_date":"2024-08-15T11:10:29+1000","url":"https://announcements.asx.com.au/asxpdf/20240815/pdf/066nb5j4zm2h0r.pdf","relative_url":"/asxpdf/20240815/pdf/066nb5j4zm2h0r.pdf","header":"Proposed issue of securities - AEE","market_sensitive":false,"number_of_pages":5,"size":"17.8KB","legacy_announcement":false,"issuer_code":"AEE","issuer_short_name":"AURA EN","issuer_full_name":"AURA ENERGY LIMITED"},{"id":"02839880","document_release_date":"2024-08-15T10:46:59+1000","document_date":"2024-08-15T10:45:58+1000","url":"https://announcements.asx.com.au/asxpdf/20240815/pdf/066n8s93g4tw68.pdf","relative_url":"/asxpdf/20240815/pdf/066n8s93g4tw68.pdf","header":"Proposed issue of securities - AEE","market_sensitive":false,"number_of_pages":5,"size":"17.7KB","legacy_announcement":false,"issuer_code":"AEE","issuer_short_name":"AURA EN","issuer_full_name":"AURA ENERGY LIMITED"},{"id":"02839783","document_release_date":"2024-08-15T09:32:09+1000","document_date":"2024-08-15T09:28:41+1000","url":"https://announcements.asx.com.au/asxpdf/20240815/pdf/066n1z9htrvrq4.pdf","relative_url":"/asxpdf/20240815/pdf/066n1z9htrvrq4.pdf","header":"Curzon Restructure and Placement","market_sensitive":true,"number_of_pages":3,"size":"241.6KB","legacy_announcement":false,"issuer_code":"AEE","issuer_short_name":"AURA EN","issuer_full_name":"AURA ENERGY LIMITED"},{"id":"02836482","document_release_date":"2024-08-06T08:17:29+1000","document_date":"2024-08-05T23:56:32+1000","url":"https://announcements.asx.com.au/asxpdf/20240806/pdf/066bdw1w073wr1.pdf","relative_url":"/asxpdf/20240806/pdf/066bdw1w073wr1.pdf","header":"Change in substantial holding","market_sensitive":false,"number_of_pages":3,"size":"451.3KB","legacy_announcement":false,"issuer_code":"AEE","issuer_short_name":"AURA EN","issuer_full_name":"AURA ENERGY LIMITED"},{"id":"02834588","document_release_date":"2024-07-31T11:32:38+1000","document_date":"2024-07-31T11:25:28+1000","url":"https://announcements.asx.com.au/asxpdf/20240731/pdf/0664p422tjx4l0.pdf","relative_url":"/asxpdf/20240731/pdf/0664p422tjx4l0.pdf","header":"Quarterly Activities/Appendix 5B Cash Flow Report","market_sensitive":true,"number_of_pages":19,"size":"1.8MB","legacy_announcement":false,"issuer_code":"AEE","issuer_short_name":"AURA EN","issuer_full_name":"AURA ENERGY LIMITED"},{"id":"02829075","document_release_date":"2024-07-16T11:22:13+1000","document_date":"2024-07-16T11:20:42+1000","url":"https://announcements.asx.com.au/asxpdf/20240716/pdf/065mm7rfww9p40.pdf","relative_url":"/asxpdf/20240716/pdf/065mm7rfww9p40.pdf","header":"Change in substantial holding","market_sensitive":false,"number_of_pages":2,"size":"127.4KB","legacy_announcement":false,"issuer_code":"AEE","issuer_short_name":"AURA EN","issuer_full_name":"AURA ENERGY LIMITED"},{"id":"02829030","document_release_date":"2024-07-16T10:09:58+1000","document_date":"2024-07-16T10:07:41+1000","url":"https://announcements.asx.com.au/asxpdf/20240716/pdf/065mhvkngrbjcx.pdf","relative_url":"/asxpdf/20240716/pdf/065mhvkngrbjcx.pdf","header":"Aura Energy Presentation - Near Term Uranium Producer","market_sensitive":false,"number_of_pages":21,"size":"5.0MB","legacy_announcement":false,"issuer_code":"AEE","issuer_short_name":"AURA EN","issuer_full_name":"AURA ENERGY LIMITED"},{"id":"02828698","document_release_date":"2024-07-15T14:13:02+1000","document_date":"2024-07-15T14:12:11+1000","url":"https://announcements.asx.com.au/asxpdf/20240715/pdf/065lkkf5dtbjvb.pdf","relative_url":"/asxpdf/20240715/pdf/065lkkf5dtbjvb.pdf","header":"Application for quotation of securities - AEE","market_sensitive":false,"number_of_pages":6,"size":"18.6KB","legacy_announcement":false,"issuer_code":"AEE","issuer_short_name":"AURA EN","issuer_full_name":"AURA ENERGY LIMITED"},{"id":"02828566","document_release_date":"2024-07-15T09:25:15+1000","document_date":"2024-07-15T09:20:29+1000","url":"https://announcements.asx.com.au/asxpdf/20240715/pdf/065l73sxt2f65g.pdf","relative_url":"/asxpdf/20240715/pdf/065l73sxt2f65g.pdf","header":"Tiris Project fully permitted for development and operations","market_sensitive":true,"number_of_pages":3,"size":"231.0KB","legacy_announcement":false,"issuer_code":"AEE","issuer_short_name":"AURA EN","issuer_full_name":"AURA ENERGY LIMITED"},{"id":"02827214","document_release_date":"2024-07-10T08:41:04+1000","document_date":"2024-07-10T08:38:17+1000","url":"https://announcements.asx.com.au/asxpdf/20240710/pdf/065fwmw06ry3xn.pdf","relative_url":"/asxpdf/20240710/pdf/065fwmw06ry3xn.pdf","header":"Cleansing Notice","market_sensitive":false,"number_of_pages":2,"size":"185.5KB","legacy_announcement":false,"issuer_code":"AEE","issuer_short_name":"AURA EN","issuer_full_name":"AURA ENERGY LIMITED"},{"id":"02827205","document_release_date":"2024-07-10T08:32:44+1000","document_date":"2024-07-10T08:32:14+1000","url":"https://announcements.asx.com.au/asxpdf/20240710/pdf/065fw01sv3vc8h.pdf","relative_url":"/asxpdf/20240710/pdf/065fw01sv3vc8h.pdf","header":"Proposed issue of securities - AEE","market_sensitive":false,"number_of_pages":5,"size":"17.8KB","legacy_announcement":false,"issuer_code":"AEE","issuer_short_name":"AURA EN","issuer_full_name":"AURA ENERGY LIMITED"},{"id":"02826178","document_release_date":"2024-07-05T18:53:35+1000","document_date":"2024-07-05T18:27:27+1000","url":"https://announcements.asx.com.au/asxpdf/20240705/pdf/065bbz693196y2.pdf","relative_url":"/asxpdf/20240705/pdf/065bbz693196y2.pdf","header":"Appendix 3H","market_sensitive":false,"number_of_pages":4,"size":"256.5KB","legacy_announcement":false,"issuer_code":"AEE","issuer_short_name":"AURA EN","issuer_full_name":"AURA ENERGY LIMITED"},{"id":"02825335","document_release_date":"2024-07-04T09:57:06+1000","document_date":"2024-07-04T09:32:58+1000","url":"https://announcements.asx.com.au/asxpdf/20240704/pdf/06585g45gfpq1d.pdf","relative_url":"/asxpdf/20240704/pdf/06585g45gfpq1d.pdf","header":"Multiple project development activities underway at Tiris","market_sensitive":false,"number_of_pages":4,"size":"244.4KB","legacy_announcement":false,"issuer_code":"AEE","issuer_short_name":"AURA EN","issuer_full_name":"AURA ENERGY LIMITED"},{"id":"02824959","document_release_date":"2024-07-03T14:15:50+1000","document_date":"2024-07-03T14:07:27+1000","url":"https://announcements.asx.com.au/asxpdf/20240703/pdf/06574f2wdlx9fs.pdf","relative_url":"/asxpdf/20240703/pdf/06574f2wdlx9fs.pdf","header":"Appendix 2A","market_sensitive":false,"number_of_pages":20,"size":"553.2KB","legacy_announcement":false,"issuer_code":"AEE","issuer_short_name":"AURA EN","issuer_full_name":"AURA ENERGY LIMITED"},{"id":"02824411","document_release_date":"2024-07-02T15:03:13+1000","document_date":"2024-07-02T15:02:27+1000","url":"https://announcements.asx.com.au/asxpdf/20240702/pdf/0655pv82qkk7l0.pdf","relative_url":"/asxpdf/20240702/pdf/0655pv82qkk7l0.pdf","header":"Notification of cessation of securities - AEE","market_sensitive":false,"number_of_pages":4,"size":"14.8KB","legacy_announcement":false,"issuer_code":"AEE","issuer_short_name":"AURA EN","issuer_full_name":"AURA ENERGY LIMITED"},{"id":"02822923","document_release_date":"2024-06-28T11:16:19+1000","document_date":"2024-06-28T11:12:54+1000","url":"https://announcements.asx.com.au/asxpdf/20240628/pdf/0651bpppkcjb2m.pdf","relative_url":"/asxpdf/20240628/pdf/0651bpppkcjb2m.pdf","header":"Appendix 2A","market_sensitive":false,"number_of_pages":20,"size":"573.6KB","legacy_announcement":false,"issuer_code":"AEE","issuer_short_name":"AURA EN","issuer_full_name":"AURA ENERGY LIMITED"},{"id":"02820648","document_release_date":"2024-06-21T18:07:20+1000","document_date":"2024-06-21T18:06:29+1000","url":"https://announcements.asx.com.au/asxpdf/20240621/pdf/064tkvd733bfgx.pdf","relative_url":"/asxpdf/20240621/pdf/064tkvd733bfgx.pdf","header":"Application for quotation of securities - AEE","market_sensitive":false,"number_of_pages":6,"size":"18.2KB","legacy_announcement":false,"issuer_code":"AEE","issuer_short_name":"AURA EN","issuer_full_name":"AURA ENERGY LIMITED"},{"id":"02820221","document_release_date":"2024-06-20T18:51:48+1000","document_date":"2024-06-20T18:51:18+1000","url":"https://announcements.asx.com.au/asxpdf/20240620/pdf/064sd4xpzwk0wx.pdf","relative_url":"/asxpdf/20240620/pdf/064sd4xpzwk0wx.pdf","header":"Application for quotation of securities - AEE","market_sensitive":false,"number_of_pages":6,"size":"18.2KB","legacy_announcement":false,"issuer_code":"AEE","issuer_short_name":"AURA EN","issuer_full_name":"AURA ENERGY LIMITED"},{"id":"02818292","document_release_date":"2024-06-14T18:07:10+1000","document_date":"2024-06-14T18:00:52+1000","url":"https://announcements.asx.com.au/asxpdf/20240614/pdf/064lk6gj6qy3l1.pdf","relative_url":"/asxpdf/20240614/pdf/064lk6gj6qy3l1.pdf","header":"Application for quotation of securities - AEE","market_sensitive":false,"number_of_pages":6,"size":"18.2KB","legacy_announcement":false,"issuer_code":"AEE","issuer_short_name":"AURA EN","issuer_full_name":"AURA ENERGY LIMITED"}],"paging_next_url":"https://www.asx.com.au/asx/1/company/AEE/announcements?market_sensitive=false&count=20&before_time=2024-06-14T18:07:10+1000"}
        return data['data']
    else:
        print(f'request status code: {response.status_code}')


def main():
    tickers = sorted(['AEE','REZ','1AE','1MC','NRZ'])

    st.set_page_config(page_title = 'ASX API Data Retrieval', 
                page_icon='ðŸ“°'
                )
    
    st.title('ASX Announcements')

    task_selected = st.radio('',['Announcements','Trading Halt Tickers'])

    if task_selected == 'Announcements':

        selected_ticker = st.selectbox("Tickers",tickers)

        data = retrieve_data(selected_ticker)
        ticker_full_name = data[0]['issuer_full_name']

        
        announcements = {'title':[],'url':[],'document_release_date':[],'market_sensitive':[]}
        for d in data:
            announcements['title'].append(d['header'])
            announcements['url'].append(d['url'])
            announcements['document_release_date'].append(d['document_release_date'])
            announcements['market_sensitive'].append(d['market_sensitive'])
        
        announcements = pd.DataFrame(announcements)
        announcements[data[0]['issuer_full_name']] = announcements.apply(lambda row: f'<a href="{row["url"]}" target="_blank">{row["title"]}</a>', axis=1)
        announcements['document_release_date'] = pd.to_datetime(announcements['document_release_date']) 
        st.markdown(announcements[[data[0]['issuer_full_name'],'document_release_date','market_sensitive']].to_html(escape=False, index=False), unsafe_allow_html=True)
    
    else:
        tickers_with_trading_halt = {'ticker':[],'ticker_full_name':[]}
        for ticker in tickers:
            data = retrieve_data(ticker)
            for d in data:
                if 'Trading Halt'.lower() in d['header'].lower():
                    tickers_with_trading_halt['ticker'].append(ticker)
                    tickers_with_trading_halt['ticker_full_name'].append(d['issuer_full_name'])
                    break
        st.write(pd.DataFrame(tickers_with_trading_halt,columns=['Tickers','Ticker\'s Full Name']))



if __name__ == "__main__":
    main()